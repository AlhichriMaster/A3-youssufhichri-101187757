<!DOCTYPE html>
<html>
<head>
    <title>Quest Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div id="game-status"></div>
    <!-- <div id="sponsorship-prompt"></div> -->
    <!-- <div id="quest-setup"></div> -->
    <div id="current-quest"></div>

    <div class="deck-info">
        <div>Adventure Deck: <span id="adventure-deck-count"></span></div>
        <div>Event Deck: <span id="event-deck-count"></span></div>
    </div>

    <div id="drawn-card" class="drawn-card"></div>
    <div id="current-hand" class="current-hand"></div>

    <div id="game-controls">
        <button onclick="playTurn()" class="button">Play Turn</button>
    </div>
    
    <!-- <div id="players"></div> -->

    <script>
        let gameState = {};
        let selectedCards = {
            foe: null,
            weapons: []
        };
        let currentStageSetup = 0;

        async function playTurn() {
            const response = await fetch('http://localhost:8080/api/game/playTurn', {
                method: 'GET'
            });
            gameState = await response.json();
            renderGame();
        }

        async function respondToSponsorship(accepting) {
            const response = await fetch('http://localhost:8080/api/game/respondToSponsorship', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    playerId: gameState.currentPlayerId,
                    accepting: accepting
                })
            });
            gameState = await response.json();
            renderGame();
        }

        async function submitQuestSetup() {
            const stages = [];
            const setupDivs = document.querySelectorAll('.stage-setup');
            
            for (let stageDiv of setupDivs) {
                const foeCardId = stageDiv.getAttribute('data-foe');
                const weaponCardIds = Array.from(stageDiv.querySelectorAll('.weapon-card.selected'))
                    .map(card => card.getAttribute('data-card-id'));
                
                stages.push({
                    foeCardId: foeCardId,
                    weaponCardIds: weaponCardIds
                });
            }

            const response = await fetch('http://localhost:8080/api/game/setupQuest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sponsorId: gameState.currentSponsor,
                    stages: stages
                })
            });
            gameState = await response.json();
            renderGame();
        }

        function selectCard(cardId, cardType, stageIndex) {
            const card = document.querySelector(`[data-card-id="${cardId}"]`);
            if (cardType === 'foe') {
                const previousFoe = document.querySelector(`.stage-${stageIndex} .foe-card.selected`);
                if (previousFoe) {
                    previousFoe.classList.remove('selected');
                }
                card.classList.add('selected');
                document.querySelector(`.stage-${stageIndex}`).setAttribute('data-foe', cardId);
            } else if (cardType === 'weapon') {
                card.classList.toggle('selected');
            }
        }

        function renderGame() {
            // Drawn Card Section
            const drawnCardDiv = document.getElementById('drawn-card');
            if (gameState.pendingQuest) {
                drawnCardDiv.innerHTML = `
                    <h3>Drawn Card:</h3>
                    <div class="card">
                        <h4>${gameState.pendingQuest.id}</h4>
                        <p>Type: ${gameState.pendingQuest.type}</p>
                        ${gameState.pendingQuest.type === 'QUEST' ? `
                            <div class="sponsorship-buttons">
                                <button onclick="respondToSponsorship(true)" class="button">Accept Sponsor</button>
                                <button onclick="respondToSponsorship(false)" class="button">Decline Sponsor</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                drawnCardDiv.innerHTML = '<p>No card drawn yet</p>';
            }

            // Current Hand Section
            const currentHandDiv = document.getElementById('current-hand');
            const currentPlayer = gameState.players?.find(p => p.id === gameState.currentPlayerId);
            if (currentPlayer) {
                currentHandDiv.innerHTML = `
                    <h3>Your Hand:</h3>
                    <div class="cards">
                        ${currentPlayer.hand.map(card => `
                            <div class="card">
                                <h4>${card.id}</h4>
                                <p>Type: ${card.type}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                currentHandDiv.innerHTML = '<p>Waiting for game to start...</p>';
            }
            
            // Game Status
            document.getElementById('game-status').textContent = `Game Status: ${gameState.gameStatus}`;
            
            // Sponsorship Prompt
            const sponsorshipDiv = document.getElementById('sponsorship-prompt');
            sponsorshipDiv.innerHTML = '';
            
            if (gameState.pendingQuest && 
                gameState.questSponsorshipState && 
                gameState.questSponsorshipState.currentPlayer === gameState.currentPlayerId) {
                sponsorshipDiv.innerHTML = `
                    <h3>Quest Sponsorship</h3>
                    <p>Would you like to sponsor this quest?</p>
                    <button onclick="respondToSponsorship(true)" class="button">Accept</button>
                    <button onclick="respondToSponsorship(false)" class="button">Decline</button>
                `;
            }

            // Quest Setup
            const questSetupDiv = document.getElementById('quest-setup');
            questSetupDiv.innerHTML = '';
            
            if (gameState.pendingQuest && gameState.currentSponsor === gameState.currentPlayerId) {
                const stages = gameState.pendingQuest.stages;
                questSetupDiv.innerHTML = `
                    <h3>Quest Setup</h3>
                    ${Array(stages).fill(0).map((_, i) => `
                        <div class="stage-setup stage-${i}" data-foe="">
                            <h4>Stage ${i + 1}</h4>
                            <div class="card-selection">
                                <h5>Select Foe:</h5>
                                <div class="foe-cards">
                                    ${renderPlayerFoeCards(i)}
                                </div>
                                <h5>Select Weapons:</h5>
                                <div class="weapon-cards">
                                    ${renderPlayerWeaponCards(i)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="submitQuestSetup()" class="button">Submit Quest Setup</button>
                `;
            }
            
            // Current Quest
            const questDiv = document.getElementById('current-quest');
            questDiv.innerHTML = gameState.currentQuest ? 
                `Current Quest: ${gameState.currentQuest.name}` : 'No active quest';
            
            // Deck counts
            document.getElementById('adventure-deck-count').textContent = gameState.adventureDeckSize;
            document.getElementById('event-deck-count').textContent = gameState.eventDeckSize;
        }

        function renderPlayerFoeCards(stageIndex) {
            return gameState.players
                .find(p => p.id === gameState.currentPlayerId)
                .hand
                .filter(card => card.type === 'FOE')
                .map(card => `
                    <div class="card foe-card" 
                         data-card-id="${card.id}"
                         onclick="selectCard('${card.id}', 'foe', ${stageIndex})">
                        ${card.id}
                    </div>
                `).join('');
        }

        function renderPlayerWeaponCards(stageIndex) {
            return gameState.players
                .find(p => p.id === gameState.currentPlayerId)
                .hand
                .filter(card => card.type === 'WEAPON')
                .map(card => `
                    <div class="card weapon-card" 
                         data-card-id="${card.id}"
                         onclick="selectCard('${card.id}', 'weapon', ${stageIndex})">
                        ${card.id}
                    </div>
                `).join('');
        }

        // Initial load
        fetch('http://localhost:8080/api/game')
            .then(response => response.json())
            .then(data => {
                gameState = data;
                renderGame();
            });
    </script>
</body>
</html>